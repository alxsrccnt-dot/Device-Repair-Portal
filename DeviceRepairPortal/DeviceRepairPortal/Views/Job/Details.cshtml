@using DeviceRepairPortal.Models.Job
@using Infrastructure.ApisClients.Common
@model JobViewModel

@{
    ViewData["Title"] = "Job Details";
}

<h2 class="mb-4">Job Details</h2>

<!-- TICKET INFO -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">@Model.Ticket.Description</h5>
        <p class="mb-1"><strong>Device:</strong> @Model.Ticket.Device.Brand @Model.Ticket.Device.Model</p>
        <p class="mb-1"><strong>Serial:</strong> @Model.Ticket.Device.SerialNumber</p>
        <p class="text-muted">Created at @Model.CreateAt.ToString("yyyy-MM-dd HH:mm")</p>
    </div>
</div>

<!-- TIMELINE -->
<div class="timeline-block">
    @foreach (var phase in Model.Phases
        .OrderBy(p => p.CreateAt)
        .Select((p, i) => new { Phase = p, Index = i }))
    {
        var isTop = phase.Index % 2 == 0;
        var stateClass = phase.Phase.State.ToString().ToLower();

        <div class="timeline-item @(isTop ? "top" : "bottom") animate"
             style="animation-delay:@(phase.Index * 0.15)s">

            <div class="timeline-dot @stateClass">
                <i class="bi @GetPhaseIcon(phase.Phase.State)"></i>
            </div>

            <div class="timeline-content @stateClass">
                <strong>@phase.Phase.State</strong>
                <div class="small text-muted">
                    by @phase.Phase.CreatedBy
                </div>
                <div class="small text-muted">
                    @phase.Phase.CreateAt.ToString("yyyy-MM-dd HH:mm")
                </div>
            </div>
        </div>
    }
</div>

<!-- INVESTIGATION -->
@if (Model.Investigation != null)
{
    <div class="card mt-4">
        <div class="card-body">
            <h5>Investigation</h5>
            <strong>@Model.Investigation.Conclusion</strong>
            <p>@Model.Investigation.Description</p>
        </div>
    </div>
}
else if (User.IsInRole("Technician"))
{
    <div class="card mt-3 border-warning">
        <div class="card-header bg-warning text-dark">
            <strong>Add Investigation</strong>
        </div>

        <div class="card-body">
            <form asp-controller="Job"
                  asp-action="AddInvestigation"
                  method="post">

                <input type="hidden" name="JobId" value="@Model.Id" />

                <div class="mb-3">
                    <label class="form-label">Conclusion</label>
                    <input name="Conclusion"
                           class="form-control"
                           placeholder="e.g. Screen replacement required"
                           required />
                </div>

                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea name="Description"
                          class="form-control"
                          rows="3"
                          placeholder="Detailed technical findings"
                          required></textarea>
                </div>

                <!-- Issues (checkbox list) -->
                <div class="mb-3">
                    <label class="form-label">Related Issues</label>

                    @foreach (var issue in Model.Ticket.Issues)
                    {
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="IssueIds"
                                   value="@issue.Id" />

                            <label class="form-check-label">
                                @issue.DevicePiece (@issue.Price.ToString("C"))
                            </label>
                        </div>
                    }
                </div>

                <button type="submit" class="btn btn-warning">
                    Save Investigation
                </button>
            </form>
        </div>
    </div>
}

<!-- BILLING -->
@if (Model.BillingInformation != null)
{
    <div class="card mt-4">
        <div class="card-body">
            <h5>Billing</h5>
            <p><strong>Amount:</strong> @Model.BillingInformation.Amount.ToString("C")</p>
        </div>
    </div>
}
else if (Model.CanAddBilling())
{
    <div class="card mt-3 border-success">
        <div class="card-header bg-success text-white">
            <strong>Add Billing Information</strong>
        </div>

        <div class="card-body">
            <form asp-controller="Job"
                  asp-action="AddBilling"
                  method="post">

                <input type="hidden" name="JobId" value="@Model.Id" />

                <div class="mb-3">
                    <label class="form-label">Amount</label>
                    <input name="Amount"
                           type="number"
                           step="0.01"
                           min="0"
                           class="form-control"
                           placeholder="Total repair cost"
                           required />
                </div>

                <!-- Optional discount -->
                <div class="mb-3">
                    <label class="form-label">Discount (optional)</label>
                    <select name="DiscountId" class="form-select">
                        <option value="">No discount</option>

                        @* Example *@
                        @* Replace with real discounts *@
                        <option value="1">WELCOME10 (10%)</option>
                        <option value="2">VIP20 (20%)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-success">
                    Save Billing
                </button>
            </form>
        </div>
    </div>
}

@if (Model.CanAddRepair())
{

    <form asp-controller="Job" asp-action="AddRepairPhase" method="post" class="d-inline">
        <input type="hidden" name="jobId" value="@Model.Id" />
        <button type="submit" class="btn btn-sm btn-primary ms-3">Beggin repair procces</button>
    </form>
}

@if (Model.CanAddRepair())
{

    <form asp-controller="Job" asp-action="AddReturnPhase" method="post" class="d-inline">
        <input type="hidden" name="jobId" value="@Model.Id" />
        <button type="submit" class="btn btn-sm btn-primary ms-3">Return this device</button>
    </form>
}


@if (Model.Comments.Any())
{
    <h5>Comments</h5>
    <ul>
        @foreach (var comment in Model.Comments)
        {
            <li><p>@comment.CreateAt</p><strong>@comment.CreatedBy</strong>: @comment.Content</li>
        }
    </ul>
}
else
{

}

@functions {
    string GetPhaseIcon(State state) => state switch
    {
        State.Reception => "bi-inbox",
        State.Investigation => "bi-search",
        State.Billing => "bi-receipt",
        State.Repair => "bi-tools",
        State.Return => "bi-box-arrow-right",
        _ => "bi-circle"
    };
}